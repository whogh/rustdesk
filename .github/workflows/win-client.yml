name: Build Pre-Configured RustDesk Client

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘æ„å»º
  push:
    tags:
      - 'v*'        # åŒæ—¶æ”¯æŒæ‰“æ ‡ç­¾è§¦å‘

env:
  # ä½¿ç”¨ä¸ flutter-build.yml ç›¸åŒçš„ç‰ˆæœ¬
  RUST_VERSION: "1.75"
  LLVM_VERSION: "15.0.6"
  FLUTTER_VERSION: "3.24.5"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"

jobs:
  build-windows:
    name: Build Windows MSI (Pre-Configured)
    runs-on: windows-2022 # ä½¿ç”¨ä¸æˆåŠŸé…ç½®ç›¸åŒçš„è¿è¡Œç¯å¢ƒ

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: âš™ï¸ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          target: x86_64-pc-windows-msvc
          cache: true

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: ${{ env.LLVM_VERSION }}

      - name: Install flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: C:\vcpkg
          vCPKGGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
          doNotCache: false

      - name: ğŸ”§ Embed Server Configuration
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•
          New-Item -ItemType Directory -Force -Path "target" | Out-Null
          
          # å°†è‡ªå®šä¹‰é…ç½®å†™å…¥æ„å»ºç³»ç»Ÿæœ€ç»ˆä¼šè¯»å–çš„é»˜è®¤ä½ç½®
          $configContent = @"
          [options]
          key = "${{ secrets.RUSTDESK_KEY }}"
          relay-server = "${{ secrets.RUSTDESK_RELAY_SERVER }}"
          api-server = "${{ secrets.RUSTDESK_API_SERVER }}"
          lock-setting = "all"
          enable-always-relay = true
          custom-id-prefix = "MYCOMPANY-"
          "@
          $configContent | Out-File -FilePath "target\RustDesk.toml" -Encoding utf8
          Write-Host "âœ… æœåŠ¡å™¨é…ç½®å·²åµŒå…¥åˆ°å®¢æˆ·ç«¯ç¨‹åºä¸­ã€‚"

      - name: ğŸ› ï¸ Apply Rust Compiler Workarounds
        run: |
          # ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹Cargoé…ç½®ä»¥ç¦ç”¨ç‰¹å®šçš„è­¦å‘Š
          # è¿™ä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„.cargo/config.tomlæ–‡ä»¶
          $cargoConfig = @"
          [build]
          rustflags = ["-A", "static_mut_refs", "-A", "unused_must_use"]
          "@
          New-Item -ItemType Directory -Force -Path ".cargo" | Out-Null
          $cargoConfig | Out-File -FilePath ".cargo/config.toml" -Encoding utf8
          Write-Host "âœ… å·²åº”ç”¨Rustç¼–è¯‘å™¨ä¸´æ—¶è§£å†³æ–¹æ¡ˆ"

      - name: ğŸš€ Build MSI Installer
        run: python .\build.py --portable --hwcodec --flutter --vram --skip-portable-pack

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-Windows-Preconfigured
          path: target/**/*.msi
