name: Build Pre-Configured RustDesk Client

on:
  workflow_dispatch: # 允许手动触发构建
  push:
    tags:
      - 'v*'        # 同时支持打标签触发

env:
  # 使用与 flutter-build.yml 相同的版本
  RUST_VERSION: "1.75"
  LLVM_VERSION: "15.0.6"
  FLUTTER_VERSION: "3.24.5"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"

jobs:
  build-windows:
    name: Build Windows MSI (Pre-Configured)
    runs-on: windows-2022 # 使用与成功配置相同的运行环境

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ⚙️ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1 # 使用 v1 版本
        with:
          toolchain: ${{ env.RUST_VERSION }}
          target: x86_64-pc-windows-msvc
          cache: true

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: ${{ env.LLVM_VERSION }}

      - name: Install flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: C:\vcpkg
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
          doNotCache: false

      - name: 🔧 Embed Server Configuration
        run: |
          # 创建目标目录
          New-Item -ItemType Directory -Force -Path "target" | Out-Null
          
          # 将自定义配置写入构建系统最终会读取的默认位置
          $configContent = @"
          [options]
          key = "${{ secrets.RUSTDESK_KEY }}"
          relay-server = "${{ secrets.RUSTDESK_RELAY_SERVER }}"
          lock-setting = "all"
          enable-always-relay = true
          custom-id-prefix = "MYCOMPANY-"
          "@
          $configContent | Out-File -FilePath "target\RustDesk.toml" -Encoding utf8
          Write-Host "✅ 服务器配置已嵌入到客户端程序中。"

      - name: 🚀 Build MSI Installer
        run: python .\build.py --portable --hwcodec --flutter --vram --skip-portable-pack

      - name: 📤 Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-Windows-Preconfigured
          path: target/**/*.msi
