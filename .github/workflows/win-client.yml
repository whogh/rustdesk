name: Build Pre-Configured RustDesk Client

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘æ„å»º
  push:
    tags:
      - 'v*'        # åŒæ—¶æ”¯æŒæ‰“æ ‡ç­¾è§¦å‘

jobs:
  build-windows:
    name: Build Windows MSI (Pre-Configured)
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: âš™ï¸ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc
          cache: true

      - name: ğŸ“¦ Install WiX
        run: choco install wixtoolset -y --no-progress

      # æ ¸å¿ƒæ­¥éª¤ï¼šç›´æ¥ä¿®æ”¹é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œä½¿å…¶å†…ç½®æ‚¨çš„æœåŠ¡å™¨å‚æ•°
      - name: ğŸ”§ Embed Server Configuration
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•
          New-Item -ItemType Directory -Force -Path "target" | Out-Null
          
          # å°†è‡ªå®šä¹‰é…ç½®å†™å…¥æ„å»ºç³»ç»Ÿæœ€ç»ˆä¼šè¯»å–çš„é»˜è®¤ä½ç½®
          $configContent = @"
          [options]
          key = "${{ secrets.RUSTDESK_KEY }}"
          relay-server = "${{ secrets.RUSTDESK_RELAY_SERVER }}"
          api-server = "${{ secrets.RUSTDESK_API_SERVER }}"
          # é”å®šæ‰€æœ‰è®¾ç½®ï¼Œä½¿å®¢æˆ·ç«¯ç•Œé¢ä¸­çš„è®¾ç½®é€‰é¡¹ç°åŒ–ï¼Œæ— æ³•ä¿®æ”¹
          lock-setting = "all"
          # å¼ºåˆ¶ä½¿ç”¨ä¸­ç»§æ¨¡å¼ï¼Œç¡®ä¿è¿æ¥æˆåŠŸç‡
          enable-always-relay = true
          # å¯é€‰ï¼šä¸ºæ‰€æœ‰å®¢æˆ·ç«¯IDæ·»åŠ è‡ªå®šä¹‰å‰ç¼€ï¼Œä¾¿äºè¯†åˆ«
          custom-id-prefix = "MYCOMPANY-"
          "@
          $configContent | Out-File -FilePath "target\RustDesk.toml" -Encoding utf8
          Write-Host "âœ… æœåŠ¡å™¨é…ç½®å·²åµŒå…¥åˆ°å®¢æˆ·ç«¯ç¨‹åºä¸­ã€‚"

      - name: ğŸš€ Build MSI Installer
        run: python .\build.py

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-Windows-Preconfigured
          path: target/**/*.msi
